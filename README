	Техническое задание

   1.Внешние спецификации:

1.1 Условие задачи(общие требования)
Создайте чат со следующим функционалом:

-консольная программа
-регистрация пользователей - логин, пароль, имя
-вход в чат по логину/паролю
-отправка сообщений конкретному пользователю
-обмен сообщениями между всеми пользователями чата одновременно

1.2 Уточнение работы программы

Создаются 2 приложения - клиент и сервер

Запускается сначала серверное приложение, затем клиентское(без параметров - подключение с авторизацией и затем пересылкой сообщений),
либо с ключом командной строки -r (регистрация)

для клиентского приложения в том же каталоге должен быть конфигурационный файл с именем client.dat, 
где находятся данные для авторизации и регистрации
(в формате текстового файла с разделителем \r\n после каждой строки)
Строки: 
-логин
-пароль
-имя пользователя

Для серверного приложения в том же каталоге должен быть конфигурационный файл с именем serverdb.dat, 
где находятся база данных с логинами и паролями всех пользователей
(в формате текстового файла с разделителем \r\n после каждой строки)
Строки последовательно для каждого пользователя: 
-логин
-пароль
-имя пользователя

Консольный пользовательский интерфейс клиента в режиме чата с авторизацией:
Выдается меню:
[Enter command(S-send msg,A-send All, W-show msgs, q-quit)]
вводится команда:
 S - отправка сообщения другому клиенту,
   следующей строкой вводится логин
   следующей строкой вводится сообщение
 A - отправка сообщения всем клиентам,
   следующей строкой вводится сообщение
 W - вывод всех клиентов и для каждого - вывод списка принятых(>>>) и отправленных(<<<) сообщений,
 q - выход из программы

Сервер имеет также возможность ввода консольной команды (q - завершает работу сервера)

Если клиент, которому отправляется сообщение, не подключен к серверу, то сообщения для него кэшируются,
а затем, когда он подключается, выдаются ему после авторизации,
при кешировании создается файл с именем msgs-<login>.dat, после отправки сообщений он удаляется


   2.Внутренние спецификации:

2.1 общее описание
2 исполняемых файла - клиентское и серверное приложение, клиентское приложение подключается к серверному 
через сокет

сокеты реализованы в виде библиотеки с классами клиентский и серверный сокет 
и функцией подключения к серверу(connect) (файл kkoSocket.h)

для работы с файлами использованы стандартные ф-ции cstdlib


В клиенте используется:
  нити:
   -главная нить -для регистрации и авторизации и меню пользователя с выводом сообщений и командой отправки
сообщения.
   -дополнительная нить - для приема сообщений
  структуры данных:
   - map<string,clientstruct*> - отображение логин -> clientstruct*

struct clientstruct{
	string fio;
	vector<string> msgs;
	clientstruct(string d)
		:fio(d)
	{}
};

В сервере используются:
  нити:
   -главная нить -для приема входящих соединений и процедур авторизации и регистрации
   -для каждого подключенного клиента: нить обработки сообщений, приходящих от клиента
   -нить с консольным интерфейсом(команда завершения работы сервера)
  структуры данных:
   - map<string,serverstruct*>  - отображение логин -> serverstruct*

struct serverstruct{
	string fio;
	string login;
	string passw;
	Socket * volatile s;
	thread * volatile t;
public:
	void setS(Socket*s){
		this->s=s;
	}
	serverstruct(string fio,string login,string psw)
		:fio(fio),login(login),passw(psw),s(nullptr),t(nullptr)
	{}
};


Для нитей - std::thread, 
для синхронизации - std::mutex, kkoSemaphore

2.2 Описание сетевого протокола

Регистрация:

клиент посылает строки:
  R
  логин
  пароль
  ФИО

ответ сервера
  строка "ok" или "err"

Авторизация и пересылка сообщений

клиент посылает строки:
  A
  логин
  пароль

ответ сервера
  строка "ok" или "err"

  список пользователей в формате: 
    логин
    ФИО
  после чего идет пустая строка, означающая конец списка

после чего сервер присылает клиенту сообщения в формате :
  логин пользователя, от которого пришло сообщение
  сообщение 

клиент отправляет сообщения в формате:
  для сообщений 1му пользователю
    строка "S"
    логин пользователя, кому отправляется сообщение
    сообщение
  для сообщений всем пользователям
    строка "A"
    сообщение
 
2.3 Описание функций и классов

Сервер:

класс chatserver
  метод run1 - заполнение структыры данных типа map из базы,
открытие серверного сокета, регистрация и авторизация пользователей, прием входящих соединений клиентов, запуск нити обработки
сообщений от клиентов
  метод done - деинициализация и завершение программы
(деинициализация глобальной структуры данных типа map, закрытие клиентских соединений, удаление динамически выделенной памяти,
 остановка ф-ции run1 главного цикла программы с помощью закрытия серверного сокета)

функция run - нить обработки соединения с клиентом(основная функция - читает сообщения от клиента и передает другому клиенту)
функция sendMsg - процедура отправки сообщения одному пользователю по логину
функция sendMsgAll - процедура отправки сообщения всем пользователям
                                                                                                    
функция t1  - нить обработки консольных команд серверу. реализует завершение программы вызовом метода done 

Клиент:

класс chatclient
  метод run1 - 
открытие сединения с сервером, регистрация и авторизация пользователей, запуск нити чтения сообщений от клиента,
заполнение структуры данных типа map по данным, отправляемым сервером,
предоставление меню пользователя с командами отправки сообщения, вывода всех сообщений и выхода,
отправка сообщений другим пользователям и вывод всех сообщений по команде

  метод done - деинициализация и завершение программы
(деинициализация глобальной структуры данных типа map, закрытие соединения с сервером, удаление динамически выделенной памяти,
 остановка ф-ции run1 главного цикла программы)

функция run - нить обработки соединения с сервером(основная функция - читает сообщения от сервера и пишет в глобальную стркутуру)

функция readAddr - возвращает адрес сервера из файла настроек
функция readPort - возвращает порт сервера из файла настроек

Библиотеки, используемые программами:
вспомогательные перегруженные ф-ции readS и writeS для чтения и записи в файлы и сокеты

библиотека cstdlib - c-шные ф-ции для работы с файлами(fopen, fclose, fgetc и другие)

библиотека mutex - класс std::mutex для создания мьютекса

библиотека thread - класс std::thread для создания нитей

библиотека kkoSemaphore - класс kko::Semaphore - реализация семафора

библиотека kkoSocket - классы kko::Socket (для работы с сетевым соединением), 
                              kko::ServerSocket (для приема входящих соединений), 
                        ф-ция kko::connect (для подключения к серверу)

библиотека winbase.h (сервер) - функция CopyFile (копирования файла с заменой)  -- для атомарности операций записи в файлы

библиотека unistd.h  (сервер) - функция access (для проверки существования файла)

2.4 Описание механизма блокировок

Сервер:

в программе используется 3 семафора: m,m2 и mf

m - блокировка доступа к глобальной структуре map и блокировка параллельного доступа к сокетам
m2 - блокировка структур serverscruct при операциях очистки указателей и удаления сокета и самой serverstruct
mf - блокировка доступа к файлам буферов сообщений

операции чтения из сокета не блокируются, т.к. эта операция выполняется потоком только со своим сокетом,
а операция очистки выполняется после них при выходе из цикла

операции записи в сокет при отправке кэшированных сообщений блокируются только по m,
т.к. параллельно другие нити могут писать в тот же сокет, но операции очистки выполняются только тем же потоком в другом месте

операции записи в сокет при пересылке сообщений блокируются по m и m2,
т.к. параллельно другие нити могут писать в тот же сокет, и т.к. запись происходит в чужой сокет, он может быть параллельно
очищен другим потоком

по m2 блокируется также сама операция очистки serverstruct в нити обработки соединения,
а также операция delete для serverstruct в методе done()

также обоими семафорами m и m2 блокируется заполнение serverstruct при авторизации

Кроме того, m блокирует также чтение структуры данных map, потому что она может меняться при регистрации пользователя,
хотя в текущей версии это не используется и структура map формируется 1 раз в начале программы и дальше не меняется,
вместо этого при регистрации делается завершение работы сервера для его перезапуска.

3.Список участников команды и ролей
    Менеджер проекта -Калашников К 
    Программист -Калашников К
    Тестировщик -Калашников К